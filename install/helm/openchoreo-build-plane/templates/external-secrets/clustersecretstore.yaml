{{- if and .Values.vault.enabled (index .Values "external-secrets" "enabled") }}
apiVersion: external-secrets.io/v1
kind: ClusterSecretStore
metadata:
  name: vault-backend
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
  labels:
    {{- include "openchoreo-build-plane.labels" . | nindent 4 }}
spec:
  provider:
    vault:
      server: "http://hashicorp-vault.{{ .Release.Namespace }}:8200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "external-secrets"
          serviceAccountRef:
            name: "external-secrets"
            namespace: "{{ .Release.Namespace }}"
{{- end }}
