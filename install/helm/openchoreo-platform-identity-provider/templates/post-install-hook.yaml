{{- if .Values.defaultApplication.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "openchoreo-platform-identity-provider.fullname" . }}-post-install
  labels:
    {{- include "openchoreo-platform-identity-provider.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      name: {{ include "openchoreo-platform-identity-provider.fullname" . }}-post-install
      labels:
        {{- include "openchoreo-platform-identity-provider.labels" . | nindent 8 }}
    spec:
      restartPolicy: Never
      containers:
      - name: post-install-setup
        image: curlimages/curl:8.4.0
        command:
        - /bin/sh
        - -c
        - |
          set -e
          
          echo "Waiting for identity-provider service to be ready..."
          max_attempts=60
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if curl -f --max-time 5 http://{{ include "openchoreo-platform-identity-provider.fullname" . }}:{{ .Values.service.port }}/health/liveness 2>/dev/null; then
              echo "Identity provider service is responding"
              break
            fi
            
            echo "Attempt $((attempt + 1))/$max_attempts: Waiting for service to respond..."
            sleep 10
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "Timeout waiting for identity-provider service to be ready"
            exit 1
          fi
          
          # Check if the application already exists
          echo "Checking if application '{{ .Values.defaultApplication.name }}' already exists..."
          existing_apps=$(curl -s --max-time 30 'http://{{ include "openchoreo-platform-identity-provider.fullname" . }}:{{ .Values.service.port }}/applications')
          
          if echo "$existing_apps" | grep -q '"name":"{{ .Values.defaultApplication.name }}"'; then
            echo "Application '{{ .Values.defaultApplication.name }}' already exists, skipping creation"
          else
            echo "Application does not exist, creating default application..."
            curl --location 'http://{{ include "openchoreo-platform-identity-provider.fullname" . }}:{{ .Values.service.port }}/applications' \
              --header 'Content-Type: application/json' \
              --data '{
                "name": "{{ .Values.defaultApplication.name }}",
                "description": "{{ .Values.defaultApplication.description }}",
                "inbound_auth_config": [
                  {
                    "type": "oauth2",
                    "config": {
                      "client_id": "{{ .Values.defaultApplication.clientId }}",
                      "redirect_uris": [
                        "{{ .Values.defaultApplication.redirectUrl }}"
                      ],
                      "grant_types": [
                        "authorization_code"
                      ],
                      "response_types": [
                        "code"
                      ],
                      "token_endpoint_auth_methods": [
                        "client_secret_basic",
                        "client_secret_post"
                      ],
                      "pkce_required": false,
                      "public_client": true
                    }
                  }
                ]
              }' \
              --fail-with-body \
              --max-time 30 \
              --retry 3 \
              --retry-delay 5
            
            echo "Default application created successfully"
          fi
          
          # Check if the user schema already exists
          echo "Checking if user schema '{{ .Values.userDetails.userSchemaName }}' already exists..."
          existing_schemas=$(curl -s --max-time 30 'http://{{ include "openchoreo-platform-identity-provider.fullname" . }}:{{ .Values.service.port }}/user-schemas')
          
          if echo "$existing_schemas" | grep -q '"name":"{{ .Values.userDetails.userSchemaName }}"'; then
            echo "User schema '{{ .Values.userDetails.userSchemaName }}' already exists, skipping creation"
          else
            echo "User schema does not exist, creating user schema..."
            curl --location 'http://{{ include "openchoreo-platform-identity-provider.fullname" . }}:{{ .Values.service.port }}/user-schemas' \
              --header 'accept: application/json' \
              --header 'Content-Type: application/json' \
              --data '{
                "name": "{{ .Values.userDetails.userSchemaName }}",
                "schema": {
                  "username": {
                    "type": "string",
                    "required": true
                  },
                  "password": {
                    "type": "string",
                    "required": true
                  },
                  "firstName": {
                    "type": "string"
                  },
                  "lastName": {
                    "type": "string"
                  },
                  "group": {
                    "type": "string",
                    "enum": ["platformEngineer", "developer"]
                  }
                }
              }' \
              --fail-with-body \
              --max-time 30 \
              --retry 3 \
              --retry-delay 5
            
            echo "User schema created successfully"
          fi
          
          # Create default users
          {{- if .Values.userDetails.users }}
          echo "Creating default users..."
          {{- range .Values.userDetails.users }}
          # Check if the user already exists
          echo "Checking if user '{{ .username }}' already exists..."
          existing_users=$(curl -s --max-time 30 'http://{{ include "openchoreo-platform-identity-provider.fullname" $ }}:{{ $.Values.service.port }}/users')
          
          if echo "$existing_users" | grep -q '"username":"{{ .username }}"'; then
            echo "User '{{ .username }}' already exists, skipping creation"
          else
            echo "User does not exist, creating user '{{ .username }}'..."
            curl --location 'http://{{ include "openchoreo-platform-identity-provider.fullname" $ }}:{{ $.Values.service.port }}/users' \
              --header 'accept: application/json' \
              --header 'Content-Type: application/json' \
              --data '{
                "type": "{{ $.Values.userDetails.userSchemaName }}",
                "attributes": {
                  "username": "{{ .username }}",
                  "password": "{{ .password }}",
                  "firstName": "{{ .firstName }}",
                  "lastName": "{{ .lastName }}",
                  "group": "{{ .group }}"
                }
              }' \
              --fail-with-body \
              --max-time 30 \
              --retry 3 \
              --retry-delay 5
            
            echo "User '{{ .username }}' created successfully"
          fi
          {{- end }}
          {{- end }}
{{- end }}
